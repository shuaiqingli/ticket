<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hengyu.ticket.dao.TripPriceListDao">
  <insert id="save" parameterType="TripPriceList" useGeneratedKeys="true" keyColumn="id" keyProperty="id">
	insert
	into
		trip_price_list
		(<include refid="columns"/>)
	values
		(<include refid="propertys"/>)
  </insert>
  <delete id="delete" parameterType="java.lang.Integer">
	delete
	from
		trip_price_list
	where
		ID=#{id}
  </delete>
  <update id="update" parameterType="TripPriceList">
	update
		trip_price_list
	set
		`iseffect`=#{iseffect},
		`LMID`=#{lmid},
		`BeginDate`=#{begindate},
		`EndDate`=#{enddate},
		`IsForever`=#{isforever}
	where
		ID=#{id}
  </update>
  <select id="findExistsDate" parameterType="TripPriceList" resultMap="result_map">
	select
		*
	from
		trip_price_list
	where
	lmid = #{lmid}
	<if test="isforever==null or isforever==0">
		and(
			#{begindate} between BeginDate and EndDate
			or
			#{enddate} between BeginDate and EndDate
		)
	</if>
	<if test="id!=null">
		and id not in(#{id})
	</if>
	<if test="isforever!=null">
		and isforever = #{isforever}
	</if>
	limit 0,1
  </select>
  <select id="find" parameterType="java.lang.Integer" resultMap="result_map">
	select
		*
	from
		trip_price_list
	where
		ID=#{id}
  </select>
  
  <select id="findlist" resultMap="result_map2" parameterType="Page">
	select
		tpl.*,sum(tpr.weekday) as weekday
	from
		trip_price_list as tpl
	left join trip_price_rule as tpr on tpr.tplid = tpl.id
	<include refid="findlist_where"></include>
	group by 
		tpl.id
	order by
		begindate asc,IsForever asc
	limit #{startOfPage},#{pageSize}
  </select>
  
  <select id="findByTicketStore" parameterType="TicketStore" resultMap="result_map2">
  	select
		tpl.*
	from
		trip_price_list as tpl
	where
		1 = 1
-- 	and (
-- 		#{ticketDate} between begindate and enddate
-- 		or
-- 		isforever = 1 and  #{ticketDate} >= begindate
-- 	)
-- 	and
-- 		lmid = #{lmid}
-- 	order by
-- 		isforever
  </select>
  
  <select id="count" resultType="long" parameterType="Page">
	select
		count(1)
	from
		trip_price_list
	<include refid="findlist_where"></include>
  </select>
  
  <select id="findWeekdayByTripPrice" parameterType="TripPriceRule" resultMap="result_map">
	select
		sum(weekday) as weekday
	from
		trip_price_rule
	where 
		tplid = #{tplid}
	<if test="id != null ">
		and id not in(#{id})
	</if>
  </select>
  
   <select id="findisAllowUpdateLineManage" resultType="int" parameterType="int">
   		select 
   			if(count(1) = 0 or count(1) is null,1,0)
   		from 
   			trip_price_list
   		where 
   			lmid = #{lmid} and EndDate >= current_date()
   </select>
  
  <sql id="findlist_where">
  	where 
  		lmid = #{param.lmid}
  	and(
  		enddate >= CURRENT_DATE()
  	or
  		isforever = 1
  	)
  </sql>
  
  <sql id="columns">
	`iseffect`,
	`LMID`,
	`BeginDate`,
	`EndDate`,
	`IsForever`
  </sql>
  <sql id="propertys">
	#{iseffect},
	#{lmid},
	#{begindate},
	#{enddate},
	#{isforever}
  </sql>
  <resultMap id="result_map" type="TripPriceList">
    <id column="ID" property="id" javaType="java.lang.Integer"/>
    <result column="iseffect" property="iseffect" javaType="java.lang.Integer"/>
    <result column="LMID" property="lmid" javaType="java.lang.Integer"/>
    <result column="BeginDate" property="begindate" javaType="java.lang.String"/>
    <result column="EndDate" property="enddate" javaType="java.lang.String"/>
    <result column="IsForever" property="isforever" javaType="java.lang.Integer"/>
    <result column="weekday" property="weekday" javaType="java.lang.Integer"/>
  </resultMap>
  
   <resultMap type="TripPriceList" id="result_map2" extends="result_map">
  	<collection property="rules" column="id" select="com.hengyu.ticket.dao.TripPriceRuleDao.findByTripPrice"></collection>
  </resultMap>
</mapper>
